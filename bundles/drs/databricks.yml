# databricks.yml
bundle:
  name: drs__infra

include:
  - ../_common.yml
  - resources/*.yml
  - resources/*/*.yml
  #- resources/*/*/*.ipynb

sync:
  paths:
    - ../../../../src/notebooks/*.ipynb

#############################################################################
### Reusable blocks (anchors)
#############################################################################

# Workspace settings used by each target
workspace_config: &workspace_config
  host: https://dbc-0c2248b3-6656.cloud.databricks.com
  # Where `databricks bundle deploy` will place the bundle contents
  root_path: /Workspace/deployment/${var.lh_environment}/${bundle.name}/${bundle.target}/
  #root_path: /Workspace/Users/${workspace.current_user.userName}/.bundle/${bundle.name}/${bundle.target}

#_permissions: &sandbox_permissions# Permissions (reusable lists). Apply these inside resource definitions.
sand_permissions: &sandbox_permissions
  - level: CAN_MANAGE
    group_name: LakehouseEnterpriseWorkspaceAdmin
  - level: CAN_MANAGE
    group_name: LakehouseEnterpriseExpertDataEngineer
  - level: CAN_MANAGE
    user_name: ${workspace.current_user.userName}
  - level: CAN_MANAGE
    group_name: LakehouseEnterpriseWorkspaceDataEngineer
  - level: CAN_VIEW
    group_name: users
  - level: CAN_MANAGE
    service_principal_name: ${var.service_principals.sandbox}

dev_permissions: &dev_permissions
  - level: CAN_MANAGE
    group_name: LakehouseEnterpriseWorkspaceAdmin
  - level: CAN_MANAGE
    group_name: LakehouseEnterpriseExpertDataEngineer
  - level: CAN_MANAGE
    user_name: ${workspace.current_user.userName}
  - level: CAN_MANAGE
    group_name: LakehouseEnterpriseWorkspaceDataEngineer
  - level: CAN_VIEW
    group_name: users
  - level: CAN_MANAGE
    service_principal_name: ${var.service_principals.dev}

test_permissions: &test_permissions
  - level: CAN_MANAGE
    group_name: LakehouseEnterpriseWorkspaceAdmin
  - level: CAN_MANAGE
    group_name: LakehouseEnterpriseExpertDataEngineer
  - level: CAN_MANAGE
    user_name: ${workspace.current_user.userName}
  - level: CAN_MANAGE
    group_name: LakehouseEnterpriseWorkspaceDataEngineer
  - level: CAN_VIEW
    group_name: users
  - level: CAN_MANAGE
    service_principal_name: ${var.service_principals.test}

# Target-specific variable blocks (will merge into targets.variables)
dev_variable_block: &dev_variable_block
  service_principal_object_owner: ${var.service_principals.dev}
  aws_environment: dev
  lh_environment: dev
  amic_environment: dev # example; change if needed

sandbox_variable_block: &sandbox_variable_block
  service_principal_object_owner: ${var.service_principals.sandbox}
  aws_environment: sandbox # if you intend only 'dev'/'prod', adjust to 'dev' here
  lh_environment: sandbox
  amic_environment: sandbox # example; change if needed

resources:
  jobs:
    demo_New_job:
      permissions: *sandbox_permissions
  pipelines:
    my_dlt_pipeline:
      permissions: *sandbox_permissions

test_variable_block: &test_variable_block
  service_principal_object_owner: ${var.service_principals.test}
  aws_environment: test
  lh_environment: test
  amic_environment: test # example; change if needed

#############################################################################
### Deployment targets
#############################################################################

targets:
  dev:
    mode: production
    workspace: *workspace_config
    variables:
      <<: *dev_variable_block

  sandbox:
    mode: production
    workspace: *workspace_config
    variables:
      <<: *sandbox_variable_block

  test:
    mode: production
    workspace: *workspace_config
    variables:
      <<: *test_variable_block
#############################################################################
### Example: apply permissions to a resource per target (optional illustration)
#############################################################################
# (Uncomment and adapt to your actual job/pipeline names.)
#
# resources:
#   jobs:
#     my_job:
#       name: "[${var.lh_environment}] my_job"
#       tasks:
#         - task_key: run
#           notebook_task:
#             notebook_path: /Repos/path/to/notebook
#
# targets:
#   dev:
#     resources:
#       jobs:
#         my_job:
#           permissions: *dev_permissions
#   sandbox:
#     resources:
#       jobs:
#         my_job:
#           permissions: *sandbox_permissions
#   test:
#     resources:
#       jobs:
#         my_job:
#           permissions: *test_permissions
