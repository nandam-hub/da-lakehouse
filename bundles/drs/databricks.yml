# ============================================================
# Bundle Definition
# ============================================================

bundle:
  name: drs__infra

include:
  - ../_common.yml
  - resources/*.yml
  - resources/*/*.yml

# ============================================================
# Shared Workspace Configuration
# ============================================================

workspace_config: &workspace_config
  root_path: /Workspace/Users/${workspace.current_user.userName}/.bundle/${bundle.name}/${bundle.target}/

# ============================================================
# Default Permissions (User-Based Only)
# ============================================================

default_permissions: &default_permissions
  - level: CAN_MANAGE
    user_name: ${workspace.current_user.userName}

# ============================================================
# Environment Variable Blocks
# ============================================================

dev_variables: &dev_variables
  service_principal_object_owner: ${var.service_principals.dev}
  aws_environment: dev
  lh_environment: dev
  amic_environment: dev

sandbox_variables: &sandbox_variables
  service_principal_object_owner: ${var.service_principals.sandbox}
  aws_environment: sandbox
  lh_environment: sandbox
  amic_environment: sandbox

test_variables: &test_variables
  service_principal_object_owner: ${var.service_principals.test}
  aws_environment: test
  lh_environment: test
  amic_environment: test

# ============================================================
# Resources
# ============================================================

resources:

  resources:

  jobs:
    demo_job:
      name: "Demo Job"

      tasks:
        - task_key: run_notebook
          notebook_task:
            notebook_path: ./resources/ingestion.ipynb
  # jobs:
  #   demo_new_job:
  #     name: "[${var.lh_environment}] Demo Job"
  #     permissions: *default_permissions

  pipelines:
    my_dlt_pipeline:
      name: "[${var.lh_environment}] DLT Pipeline"
      libraries:
        - notebook:
            path: ./resources/ingestion.ipynb
      permissions: *default_permissions

  # pipelines:
  #   my_dlt_pipeline:
  #     name: "[${var.lh_environment}] DLT Pipeline"
  #     serverless: true   # ðŸ‘ˆ ADD THIS
  #     libraries:
  #     - notebook:
  #         path: ./resources/ingestion.ipynb


# ============================================================
# Deployment Targets
# ============================================================

targets:

  dev:
    mode: production
    workspace: *workspace_config
    variables:
      <<: *dev_variables

  sandbox:
    mode: production
    workspace: *workspace_config
    variables:
      <<: *sandbox_variables

  test:
    mode: production
    workspace: *workspace_config
    variables:
      <<: *test_variables
