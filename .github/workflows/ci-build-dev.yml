name: CI-Build Dev

on:
  push:
    branches:
      - 'DA-*'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build'
        required: false
        type: string
        default: 'main'
      environment:
        description: 'Target environment'
        required: false
        type: choice
        options:
          - dev
          - test
          - sandbox
        default: 'dev'
      image_tag:
        description: 'Custom image tag'
        required: false
        type: string
        default: 'latest'

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load AWS Region
        id: load-region
        run: |
          AWS_REGION=$(yq '.parameters.environment_variables.AWS_REGION' .github/parameters.yml)
          echo "AWS_REGION=$AWS_REGION" >> $GITHUB_ENV
          echo "aws-region=$AWS_REGION" >> $GITHUB_OUTPUT

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ steps.load-region.outputs.aws-region }}
          role-to-assume: ${{ secrets.AWS_IAM_ROLE }}
          role-session-name: github-action-dev

      - name: Get Databricks credentials from AWS Secrets Manager
        id: get-secrets
        run: |
          SECRET=$(aws secretsmanager get-secret-value --secret-id assetbundle-dev-credentials --query 'SecretString' --output text)
          echo "::add-mask::$(echo $SECRET | jq -r '.client_secret')"
          echo "DATABRICKS_HOST=$(echo $SECRET | jq -r '.databricks_host_dev')" >> $GITHUB_ENV
          echo "DATABRICKS_CLIENT_ID=$(echo $SECRET | jq -r '.service_principal_dev')" >> $GITHUB_ENV
          echo "DATABRICKS_CLIENT_SECRET=$(echo $SECRET | jq -r '.client_secret')" >> $GITHUB_ENV

      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main

      - name: Deploy bundles
        run: |
          TARGET="${{ github.event.inputs.environment || 'dev' }}"
          for bundle_dir in bundles/*/; do
            if [ -f "$bundle_dir/databricks.yml" ]; then
              echo "Deploying bundle: $(basename $bundle_dir) to target: $TARGET"
              cd "$bundle_dir"
              databricks bundle deploy --target $TARGET
              cd - > /dev/null
            fi
          done
        env:
          DATABRICKS_HOST: ${{ env.DATABRICKS_HOST }}
          DATABRICKS_CLIENT_ID: ${{ env.DATABRICKS_CLIENT_ID }}
          DATABRICKS_CLIENT_SECRET: ${{ env.DATABRICKS_CLIENT_SECRET }}
