name: CI-Build Test

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Test target"
        required: true
        type: choice
        options:
          - testa
          - testb
          - qas
        default: "testa"

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-2
          role-to-assume: ${{ secrets.AWS_IAM_ROLE }}
          role-session-name: github-action-test

      - name: Get Databricks credentials from AWS Secrets Manager
        id: get-secrets
        run: |
          SECRET=$(aws secretsmanager get-secret-value --secret-id assetbundle-test-credentials --query 'SecretString' --output text)
          echo "::add-mask::$(echo $SECRET | jq -r '.client_secret')"
          echo "DATABRICKS_HOST=$(echo $SECRET | jq -r '.databricks_host_test')" >> $GITHUB_ENV
          echo "DATABRICKS_CLIENT_ID=$(echo $SECRET | jq -r '.service_principal_test')" >> $GITHUB_ENV
          echo "DATABRICKS_CLIENT_SECRET=$(echo $SECRET | jq -r '.client_secret')" >> $GITHUB_ENV

      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main

      - name: Deploy bundles
        run: |
          TARGET="${{ github.event.inputs.target || 'testa' }}"
          for bundle_dir in bundles/*/; do
            if [ -f "$bundle_dir/databricks.yml" ]; then
              echo "Deploying bundle: $(basename $bundle_dir) to target: $TARGET"
              cd "$bundle_dir"
              databricks bundle deploy --target $TARGET
              cd - > /dev/null
            fi
          done
        env:
          DATABRICKS_HOST: ${{ env.DATABRICKS_HOST }}
          DATABRICKS_CLIENT_ID: ${{ env.DATABRICKS_CLIENT_ID }}
          DATABRICKS_CLIENT_SECRET: ${{ env.DATABRICKS_CLIENT_SECRET }}
