name: Security Scan

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Secret Scanning
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

      - name: PII Scanning
        run: |
          echo "Scanning for PII patterns..."
          pytest tests/unit/test_pii_scan.py -v
          if grep -r -E "[0-9]{3}-[0-9]{2}-[0-9]{4}|\b[0-9]{4}[[:space:]]+[0-9]{4}[[:space:]]+[0-9]{4}[[:space:]]+[0-9]{4}\b" . \
            --exclude-dir=.git \
            --exclude-dir=node_modules \
            --exclude-dir=tests \
            --exclude-dir=fixtures \
            --exclude="*.lock" \
            --exclude="*.lock.hcl" \
            --exclude="uv.lock" \
            --exclude="*.ipynb" \
            --exclude="*.parquet" \
            --exclude="*test*" \
            --binary-files=without-match | grep -v "hash.*sha256" | grep -v "commandId" | grep -v "abc123def456789012345678901234ab"; then
            echo "⚠️ Potential PII detected - BLOCKING MERGE"
            exit 1
          else
            echo "✅ No PII patterns found"
          fi

  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-prod.txt ]; then pip install -r requirements-prod.txt; fi

      - name: Run unit tests
        run: |
          pytest tests/unit --cov -v

  integration-tests:
    runs-on: ubuntu-latest
    needs: [security-scan, unit-tests]
    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
      DATABRICKS_CONFIG_PROFILE: newEWS
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | bash
          echo "$HOME/.databricks/bin" >> $GITHUB_PATH
          export PATH="$HOME/.databricks/bin:$PATH"
          databricks version

      - name: Create Databricks profile
        run: |
          cat > "$HOME/.databrickscfg" <<EOF
          [newEWS]
          host = ${DATABRICKS_HOST}
          auth_type = oauth-m2m
          client_id = ${DATABRICKS_CLIENT_ID}
          client_secret = ${DATABRICKS_CLIENT_SECRET}
          EOF
          chmod 600 "$HOME/.databrickscfg"

      - name: Install dependencies
        run: |
          pip install pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-prod.txt ]; then pip install -r requirements-prod.txt; fi

      - name: Run integration tests
        run: |
          pytest tests/integration -v

  data-quality-tests:
    runs-on: ubuntu-latest
    needs: [integration-tests]
    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_CLIENT_ID: ${{ secrets.DATABRICKS_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.DATABRICKS_CLIENT_SECRET }}
      DATABRICKS_CONFIG_PROFILE: newEWS
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pytest pyspark
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run data quality tests
        run: |
          pytest tests/data_quality -v
