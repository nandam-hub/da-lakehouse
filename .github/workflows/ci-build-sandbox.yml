name: CI-Build Sandbox

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment"
        required: false
        type: string
        default: "sandbox"
      bundle_name:
        description: "Specific bundle to deploy (optional)"
        required: false
        type: string
        default: ""

  push:
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: false
        type: choice
        options:
          - sandbox
        default: "sandbox"

permissions:
  id-token: write
  contents: read
  security-events: write

jobs:
  build:
    uses: ./.github/workflows/build-template.yml
    with:
      environment: ${{ inputs.environment || 'sandbox' }}
      image_tag: 'latest'
    secrets: inherit
    permissions:
      contents: read
      id-token: write

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install yq
        run: sudo snap install yq

      - name: Load AWS Region
        id: load-region
        run: |
          AWS_REGION=$(yq eval '.parameters.environment_variables.AWS_REGION' .github/parameters.yml)
          echo "AWS_REGION=$AWS_REGION" >> $GITHUB_ENV
          echo "aws-region=$AWS_REGION" >> $GITHUB_OUTPUT

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE }}
          aws-region: ${{ steps.load-region.outputs.aws-region }}
          audience: sts.amazonaws.com

      - name: Get Databricks credentials from AWS Secrets Manager
        id: get-secrets
        shell: pwsh
        run: |
          # Get secret from AWS Secrets Manager
          Write-Host "Fetching secret from AWS Secrets Manager..."
          $SECRET_SP = $(aws secretsmanager get-secret-value --secret-id assetbundle-sandbox-credenttials --query 'SecretString' --output text)

          if (-not $SECRET_SP) {
              Write-Host "ERROR: Failed to retrieve secret from AWS Secrets Manager"
              exit 1
          }

          Write-Host "Secret retrieved successfully"
          Write-Host "Raw secret (first 50 chars): $($SECRET_SP.Substring(0, [Math]::Min(50, $SECRET_SP.Length)))..."

          $ENVIRONMENT = "${{inputs.environment || 'sandbox'}}"
          Write-Host "Target environment: $ENVIRONMENT"

          try {
              $secretObj = $SECRET_SP | ConvertFrom-Json
              Write-Host "Secret parsed successfully"
          } catch {
              Write-Host "ERROR: Failed to parse secret JSON: $_"
              Write-Host "Raw secret content: $SECRET_SP"
              exit 1
          }

          # Extract the fields (match the exact JSON property names)
          $SERVICE_PRINCIPAL = $secretObj.service_principal_sandbox
          $CLIENT_SECRET     = $secretObj.client_secret
          $DATABRICKS_HOST   = $secretObj."databricks_host_sandbox"

          Write-Host "=== Extracted Values ==="
          Write-Host "Service principal: $SERVICE_PRINCIPAL"
          Write-Host "Host: $DATABRICKS_HOST"
          Write-Host "Client secret length: $($CLIENT_SECRET.Length)"

          # Validate required fields
          if (-not $SERVICE_PRINCIPAL -or -not $CLIENT_SECRET -or -not $DATABRICKS_HOST) {
              Write-Host "ERROR: Missing required fields in secret"
              Write-Host "Available keys in secret: $($secretObj.PSObject.Properties.Name -join ', ')"
              exit 1
          }

          $configPath = Join-Path $home ".databrickscfg"

          # Read existing config if it exists
          $existingContent = ""
          if (Test-Path $configPath) {
              $existingContent = Get-Content $configPath -Raw
              Write-Host "Existing config found"
          }

          # Prepare new profile content
          $DATABRICKS_CONFIG_PROFILE = "${{inputs.environment || 'sandbox'}}"
          $profileName   = $DATABRICKS_CONFIG_PROFILE
          $host_url          = $DATABRICKS_HOST
          $clientId      = $SERVICE_PRINCIPAL
          $clientSecret  = $CLIENT_SECRET

          # Create new profile section
          $oauth = "oauth-m2m"
          $newProfileLines = @(
              ""
              "[$profileName]"
              "host = $host_url"
              "auth_type = $oauth"
              "client_id = $clientId"
              "client_secret = $clientSecret"
          )

          $newProfileContent = ($newProfileLines -join [Environment]::NewLine)

          # Remove existing profile if it exists, then append new one
          $pattern = "\[" + [regex]::Escape($profileName) + "\][\s\S]*?(?=\n\[|$)"
          $updatedContent = $existingContent -replace $pattern, ""
          $finalContent = $updatedContent.TrimEnd() + $newProfileContent

          Set-Content -LiteralPath $configPath -Value $finalContent -Encoding ASCII

          Write-Host "Databricks config written to: $configPath"
          Write-Host "=== Final Config Content ==="
          if (Test-Path $configPath) {
              Get-Content $configPath
              Write-Host "=== End Config Content ==="

              # Verify sandbox profile exists
              $configContent = Get-Content $configPath -Raw
              if ($configContent -match "\[sandbox\]") {
                  Write-Host "✅ SUCCESS: Sandbox profile created successfully"
              } else {
                  Write-Host "❌ ERROR: Sandbox profile NOT found in config file"
                  Write-Host "Config file size: $((Get-Item $configPath).Length) bytes"
                  exit 1
              }
          } else {
              Write-Host "❌ ERROR: Config file was not created at $configPath"
              exit 1
          }

      - name: Verify Databricks Profile
        run: |
          echo "=== Verifying Databricks Profile ==="
          if [ -f "$HOME/.databrickscfg" ]; then
            echo "Config file exists"
            echo "Config file content:"
            cat "$HOME/.databrickscfg"
            echo "=== End Config ==="

            if grep -q "\[sandbox\]" "$HOME/.databrickscfg"; then
              echo "✅ Sandbox profile found"
            else
              echo "❌ Sandbox profile NOT found"
              exit 1
            fi
          else
            echo "❌ Config file does not exist"
            exit 1
          fi

      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main

      - name: Deploy bundles
        run: |
          TARGET="${{ inputs.environment || 'sandbox' }}"
          BUNDLE_NAME="${{ inputs.bundle_name || '' }}"
          echo "Deploying to target: $TARGET"

          if [ -n "$BUNDLE_NAME" ]; then
            echo "Deploying specific bundle: $BUNDLE_NAME"
            if [ -f "bundles/$BUNDLE_NAME/databricks.yml" ]; then
              cd "bundles/$BUNDLE_NAME"
              databricks bundle deploy --target "$TARGET" --profile "$TARGET"
              cd - > /dev/null
            else
              echo "❌ Bundle not found: $BUNDLE_NAME"
              exit 1
            fi
          else
            echo "Deploying all bundles"
            for bundle_dir in bundles/*/; do
              if [ -f "$bundle_dir/databricks.yml" ]; then
                echo "Deploying bundle: $(basename $bundle_dir) to target: $TARGET"
                cd "$bundle_dir"
                databricks bundle deploy --target "$TARGET" --profile "$TARGET"
                cd - > /dev/null
              fi
            done
          fi
