name: CI-Build Workflow

on:
  push:
    branches:
      - main
      - 'feature/*'
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: false
        type: choice
        options:
          - sandbox
        default: "sandbox"
      bundle_name:
        description: "Specific bundle to deploy (optional)"
        required: false
        type: string
        default: ""

permissions:
  id-token: write
  contents: read

jobs:
  call-sandbox-deployment:
    uses: ./.github/workflows/ci-build-sandbox.yml
    with:
      environment: ${{ inputs.environment || 'sandbox' }}
      bundle_name: ${{ inputs.bundle_name || '' }}
    secrets: inherit

  summary:
    runs-on: ubuntu-latest
    needs: [call-sandbox-deployment]
    if: always()
    
    steps:
      - name: Deployment Summary
        run: |
          echo "=== CI-Build Workflow Summary ==="
          echo "Environment: ${{ inputs.environment || 'sandbox' }}"
          echo "Bundle: ${{ inputs.bundle_name || 'All bundles' }}"
          echo "Triggered by: ${{ github.event_name == 'push' && 'Push' || github.actor }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "================================"
          
          if [ "${{ needs.call-sandbox-deployment.result }}" == "success" ]; then
            echo "✅ Sandbox deployment: SUCCESS"
          elif [ "${{ needs.call-sandbox-deployment.result }}" == "failure" ]; then
            echo "❌ Sandbox deployment: FAILED"
          else
            echo "⏭️ Sandbox deployment: SKIPPED"
          fi