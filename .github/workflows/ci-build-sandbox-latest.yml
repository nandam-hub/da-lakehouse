deploy:
  needs: build
  runs-on: self-hosted
  timeout-minutes: 60

  defaults:
    run:
      shell: bash

  permissions:
    contents: read
    id-token: write

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install PyYAML jq

    - name: Load AWS Region
      id: load-region
      run: |
        if [ -f ".github/parameters.yml" ]; then
          AWS_REGION=$(python -c "import yaml; print(yaml.safe_load(open('.github/parameters.yml'))['parameters']['environment_variables']['AWS_REGION'])")
        else
          AWS_REGION="us-east-1"
        fi
        echo "AWS_REGION=$AWS_REGION" >> $GITHUB_ENV
        echo "aws-region=$AWS_REGION" >> $GITHUB_OUTPUT

    - name: Configure AWS Credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_IAM_ROLE }}
        aws-region: ${{ steps.load-region.outputs.aws-region }}

    - name: Get Databricks credentials
      id: get-secrets
      run: |
        SECRET_NAME="databricks-serviceprincipal-dev"

        SECRET_SP=$(aws secretsmanager get-secret-value \
          --secret-id "$SECRET_NAME" \
          --query 'SecretString' \
          --output text)

        SERVICE_PRINCIPAL=$(echo "$SECRET_SP" | jq -r '.service_principal_sandbox')
        CLIENT_SECRET=$(echo "$SECRET_SP" | jq -r '.client_secret')
        DATABRICKS_HOST=$(echo "$SECRET_SP" | jq -r '.databricks_host_sandbox')

        mkdir -p ~/.databricks

        cat > ~/.databrickscfg << EOF
        [sandbox]
        host = $DATABRICKS_HOST
        auth_type = oauth-m2m
        client_id = $SERVICE_PRINCIPAL
        client_secret = $CLIENT_SECRET
        EOF

        echo "DATABRICKS_HOST=$DATABRICKS_HOST" >> $GITHUB_ENV

    - name: Install Databricks CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
        echo "$HOME/.databricks/bin" >> $GITHUB_PATH

    - name: Deploy bundles
      run: |
        TARGET="sandbox"

        for bundle_dir in bundles/*/; do
          if [ -f "$bundle_dir/databricks.yml" ]; then
            cd "$bundle_dir"
            databricks bundle deploy --target "$TARGET" --profile "$TARGET" --force-lock
            cd -
          fi
        done
